var Re=Object.defineProperty,Ie=Object.defineProperties;var Ne=Object.getOwnPropertyDescriptors;var Ee=Object.getOwnPropertySymbols;var ve=Object.prototype.hasOwnProperty,Ce=Object.prototype.propertyIsEnumerable;var re=(t,e,s)=>e in t?Re(t,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[e]=s,q=(t,e)=>{for(var s in e||(e={}))ve.call(e,s)&&re(t,s,e[s]);if(Ee)for(var s of Ee(e))Ce.call(e,s)&&re(t,s,e[s]);return t},K=(t,e)=>Ie(t,Ne(e));var f=(t,e,s)=>(re(t,typeof e!="symbol"?e+"":e,s),s);const Me=function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))n(a);new MutationObserver(a=>{for(const i of a)if(i.type==="childList")for(const l of i.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&n(l)}).observe(document,{childList:!0,subtree:!0});function s(a){const i={};return a.integrity&&(i.integrity=a.integrity),a.referrerpolicy&&(i.referrerPolicy=a.referrerpolicy),a.crossorigin==="use-credentials"?i.credentials="include":a.crossorigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function n(a){if(a.ep)return;a.ep=!0;const i=s(a);fetch(a.href,i)}};Me();const _e=(t,e,s)=>{const n=t.createGain();return s&&n.gain.setValueAtTime(s,t.currentTime),n.connect(t.destination),{audioCtx:t,buffers:e,playClip:(a,i={})=>{const{when:l,volume:r,offset:o,duration:c,loop:u,onEnded:d}=i,E=e[a];if(E){const m=t.createBufferSource(),T=t.createGain();r&&T.gain.setValueAtTime(r,t.currentTime),m.buffer=E,m.loop=!!u,m.connect(T),T.connect(n),m.start(l,o,c),d&&(m.onended=()=>d())}}}};class S{constructor(){f(this,"enabled",!0)}}class W{constructor(){f(this,"ecs");f(this,"enabled",!0)}}class Le{constructor(){f(this,"map",new Map)}add(e){this.map.set(e.constructor,e)}get(e){return this.map.get(e)}has(e){return this.map.has(e)}hasAll(e){for(let s of e)if(!this.map.has(s))return!1;return!0}delete(e){this.map.delete(e)}}class Oe{constructor(){f(this,"nextEntityID",0);f(this,"entitiesToDestroy",new Array);f(this,"entities",new Map);f(this,"systems",new Map)}addEntity(){let e=this.nextEntityID;return this.nextEntityID++,this.entities.set(e,new Le),e}removeEntity(e){this.entitiesToDestroy.push(e)}removeAllEntities(){this.entities.forEach((e,s)=>this.destroyEntity(s))}destroyEntity(e){this.entities.delete(e);for(let s of this.systems.values())s.delete(e)}addComponent(e,s){var n;(n=this.entities.get(e))==null||n.add(s),this.checkE(e)}getComponents(e){return this.entities.get(e)}removeComponent(e,s){var n;(n=this.entities.get(e))==null||n.delete(s),this.checkE(e)}checkE(e){for(let s of this.systems.keys())this.checkES(e,s)}checkES(e,s){var i,l;let n=this.entities.get(e),a=s.componentsRequired;n!=null&&n.hasAll(a)?(i=this.systems.get(s))==null||i.add(e):(l=this.systems.get(s))==null||l.delete(e)}addSystem(e){if(e.componentsRequired.size==0){console.warn("System "+e+" not added: empty components list.");return}e.ecs=this,this.systems.set(e,new Set);for(let s of this.entities.keys())this.checkES(s,e)}removeSystem(e){this.systems.delete(e)}update(e){for(let[s,n]of this.systems.entries())s.enabled&&s.update(n,e);for(;this.entitiesToDestroy.length>0;)this.destroyEntity(this.entitiesToDestroy.pop())}}class Pe{constructor(e,s,n){f(this,"context");f(this,"urlList");f(this,"onload");f(this,"bufferList");f(this,"loadCount");this.context=e,this.urlList=s,this.onload=n,this.bufferList=[],this.loadCount=0}loadBuffer(e,s){let n=new XMLHttpRequest;n.open("GET",e,!0),n.responseType="arraybuffer",n.onload=()=>{this.context.decodeAudioData(n.response,a=>{if(!a){alert("error decoding file data: "+e);return}this.bufferList[s]=a,++this.loadCount==this.urlList.length&&this.onload(this.bufferList)},a=>{console.error("decodeAudioData error",a)})},n.onerror=()=>{alert("BufferLoader: XHR error")},n.send()}load(){for(let e=0,s=this.urlList.length;e<s;++e)this.loadBuffer(this.urlList[e],e)}}var A=(t=>(t[t.PLACEHOLDER=0]="PLACEHOLDER",t[t.SPRITE=1]="SPRITE",t[t.DIRECTIONAL_SPRITE=2]="DIRECTIONAL_SPRITE",t))(A||{}),h=(t=>(t[t.START=0]="START",t[t.CENTER=1]="CENTER",t[t.END=2]="END",t))(h||{}),I=(t=>(t[t.PLAYER=0]="PLAYER",t[t.PROJECTILE=1]="PROJECTILE",t[t.ENEMY=2]="ENEMY",t))(I||{}),B=(t=>(t[t.FRIENDLY=0]="FRIENDLY",t[t.NEUTRAL=1]="NEUTRAL",t[t.ENEMY=2]="ENEMY",t))(B||{}),se=(t=>(t[t.RECTANGLE=0]="RECTANGLE",t[t.CIRCLE=1]="CIRCLE",t))(se||{}),_=(t=>(t[t.SEMIAUTO=0]="SEMIAUTO",t[t.AUTO=1]="AUTO",t[t.BURST=2]="BURST",t))(_||{}),b=(t=>(t[t.SINE_VERTICAL=0]="SINE_VERTICAL",t[t.SINE_HORIZONTAL=1]="SINE_HORIZONTAL",t[t.SINE_VERTICAL_STATIONARY=2]="SINE_VERTICAL_STATIONARY",t[t.HORIZONTAL_BAF=3]="HORIZONTAL_BAF",t[t.FOLLOW=4]="FOLLOW",t))(b||{});const ae=t=>new Promise((e,s)=>{let n=new Image;n.onload=()=>e(n),n.onerror=s,n.src=t}),Ye=(t,e)=>new Promise(s=>new Pe(t,e.map(n=>n.url),n=>{const a=n.map((l,r)=>[e[r].name,l]),i=Object.fromEntries(a);s(i)}).load()),G=(t,e,s)=>{let n=t*Math.cos(s)-e*Math.sin(s),a=t*Math.sin(s)+e*Math.cos(s);return{x:n,y:a}},pe=t=>{if(t.x===0&&t.y===0)return t;let e=Math.sqrt(t.x**2+t.y**2);return{x:t.x/e,y:t.y/e}},ie=(t=0,e,s=!0)=>s?Math.floor(Math.random()*(e-t+1))+t:Math.random()*(e-t+1)+t,ee=({x:t,y:e},{width:s,height:n,horizontalAlign:a,verticalAlign:i})=>({x:me(t,s,a),y:me(e,n,i)}),me=(t,e,s)=>{switch(s){case h.START:return t;case h.CENTER:return Math.floor(t-e/2);case h.END:return t-e;default:return t}},g=(t=[],e="loop",s=6,n)=>({type:e,frames:t,fps:s,callback:n}),be=t=>{let e={};const s=Array.from(t);for(let n=0;n<s.length;n++)e=K(q({},e),{[s[n]]:n});return e},Ge=t=>{const{x:e,y:s}=t;return e===0&&s===-1?"N":e===1&&s===0?"E":e===0&&s===1?"S":e===-1&&s===0?"W":e>0&&s<0?"NE":e<0&&s<0?"NW":e>0&&s>0?"SE":e<0&&s>0?"SW":"default"},D=({x:t,y:e})=>({dirX:t,dirY:e}),we=()=>{const t=canvas.width/canvas.height;window.innerWidth<window.innerHeight*t?(canvas.style.width="100%",canvas.style.height="auto"):(canvas.style.width="auto",canvas.style.height="95vh")},ye=t=>{t.removeAllEntities();const e=ce(t);GAMESTATE={paused:!1,scene:"game",playerEntity:e,lives:3,score:0}},Y={ship1_default:g([{x:0,y:0}]),ship1_turning_right:g([{x:28,y:0},{x:56,y:0}],"hold"),ship1_turning_left:g([{x:84,y:0},{x:112,y:0}],"hold"),explosion_small:g([{x:84,y:112},{x:98,y:112},{x:84,y:126}],"single",12,(t,e)=>t.removeEntity(e)),explosion_large:g([{x:0,y:112},{x:28,y:112},{x:56,y:112}],"single",12,(t,e)=>t.removeEntity(e))};class x extends S{constructor(e,s){super(),this.x=e,this.y=s}}class L extends S{constructor(e,s){super(),this.x=e,this.y=s}}class w extends S{constructor(e,s,n=h.START,a=h.START){super(),this.width=e,this.height=s,this.horizontalAlign=n,this.verticalAlign=a}}class M extends S{constructor(e){super(),this.value=e}}class ne extends S{constructor(e){super(),this.type=e}}class V extends S{constructor(e){super(),this.type=e}}class X extends S{constructor(e,s){super(),this.max=e,this.curr=s}}class Ae extends S{constructor(e){super(),this.value=e}}class le extends S{constructor(){super()}}class H extends S{constructor(e){super(),this.value=e}}class j extends S{constructor(e){super(),this.value=e}}class y extends S{constructor(e,s,n,a={}){super(),this.spriteType=e,this.style=s,this.currSprite=n,this.sprites=a,a.default=n}}class N extends S{constructor(s={default:g()},n="default"){super();f(this,"currFrame",0);f(this,"lastFrameTime",0);this.animations=s,this.state=n}setState(s){this.state=this.animations[s]?s:"default",this.currFrame=0,this.lastFrameTime=0}}class z extends S{constructor(e,s){super(),this.gun=e,this.defaultOffset=s}}class te extends S{constructor(e,s=0){super(),this.gunList=e,this.active=s}getActive(){return this.gunList[this.active]}}const ce=(t,e=canvas.width/2-14,s=canvas.height-50)=>{const n=t.addEntity();return GAMESTATE.playerEntity=n,[new le,new x(e,s),new H(I.PLAYER),new w(28,28),new ne(se.RECTANGLE),new L(0,-1),new M(120),new X(5,5),new te([{fireMode:_.AUTO,fireRate:300,damage:1,bulletType:"default",bullets:[{dirX:0,dirY:-1},D(G(0,-1,45)),D(G(0,-1,-45))]},{fireMode:_.AUTO,fireRate:200,damage:2,bulletType:"wave_u",bullets:[{dirX:0,dirY:-1,offsetY:7},{dirX:-1,dirY:0,offsetX:-14,offsetY:14,type:"wave_l"},{dirX:1,dirY:0,offsetX:14,offsetY:14,type:"wave_r"}]},{fireMode:_.AUTO,fireRate:80,damage:4,bulletType:"ball_green",bullets:[{dirX:0,dirY:-1,offsetY:7}]}]),new y(A.SPRITE,"white",{x:0,y:0}),new N({default:Y.ship1_default,turning_right:Y.ship1_turning_right,turning_left:Y.ship1_turning_left,death:Y.explosion_large})].forEach(i=>{t.addComponent(n,Object.create(i))}),n};class De extends W{constructor(){super(...arguments);f(this,"componentsRequired",new Set([N,y]))}update(s,n){s.forEach(a=>{const i=this.ecs.getComponents(a);let l=i.get(y),r=i.get(N);const o=new Date().getTime();r.animations[r.state]===void 0&&r.setState("default");let c=r.animations[r.state];const u=1e3/c.fps;if(!(c.frames.length<1)&&(r.lastFrameTime||(r.lastFrameTime=o),o-r.lastFrameTime>u&&l.currSprite!==c.frames[r.currFrame]||!c.frames.includes(l.currSprite))){if(c.type==="loop")r.currFrame=r.currFrame%c.frames.length;else if(c.type==="single"&&r.currFrame>=c.frames.length){if(c.callback){c.callback(this.ecs,a);return}r.setState("default")}else c.type==="hold"&&r.currFrame>=c.frames.length&&(r.currFrame=c.frames.length-1);const d=c.frames[r.currFrame];l.currSprite=d,r.lastFrameTime=o,r.currFrame+=1}})}}const Xe=t=>{switch(t){case"ball_purple":return[new w(12,12,h.CENTER,h.CENTER),new y(A.SPRITE,"green",{x:58,y:85})];case"ball_green":return[new w(12,12,h.CENTER,h.CENTER),new y(A.SPRITE,"purple",{x:70,y:85})];case"ball_purple_small":return[new w(5,5,h.CENTER,h.CENTER),new y(A.SPRITE,"green",{x:57,y:99})];case"ball_green_small":return[new w(5,5,h.CENTER,h.CENTER),new y(A.SPRITE,"purple",{x:62,y:99})];case"wave_u":return[new w(12,5,h.CENTER,h.CENTER),new y(A.SPRITE,"yellow",{x:1,y:99})];case"wave_d":return[new w(12,5,h.CENTER,h.CENTER),new y(A.SPRITE,"yellow",{x:1,y:105})];case"wave_l":return[new w(5,12,h.CENTER,h.CENTER),new y(A.SPRITE,"yellow",{x:1,y:85})];case"wave_r":return[new w(5,12,h.CENTER,h.CENTER),new y(A.SPRITE,"yellow",{x:8,y:85})];case"laser_h":return[new w(12,4,h.CENTER,h.CENTER),new y(A.SPRITE,"yellow",{x:15,y:83}),new N({default:g([{x:15,y:84},{x:15,y:89},{x:15,y:94}],"loop",12)})];case"laser_v":return[new w(4,12,h.CENTER,h.CENTER),new y(A.SPRITE,"yellow",{x:14,y:99}),new N({default:g([{x:14,y:99},{x:19,y:99},{x:24,y:99}],"loop",12)})];default:return[new w(8,8,h.CENTER,h.CENTER),new y(A.DIRECTIONAL_SPRITE,"yellow",{x:38,y:86},{N:{x:38,y:86},NE:{x:46,y:86},E:{x:46,y:94},SE:{x:46,y:102},S:{x:38,y:102},SW:{x:30,y:102},W:{x:30,y:94},NW:{x:30,y:86}})]}},Ue=(t,e=B.FRIENDLY,s,n,a={x:0,y:-1},i,l=1,r=200)=>{const o=t.addEntity();return[new H(I.PROJECTILE),new j(e),new x(s,n),new Ae(l),new M(r),new ne(se.RECTANGLE),new L(a.x,a.y),...Xe(i)].forEach(u=>{t.addComponent(o,Object.create(u))}),o},ge=(t,e,s,n,a={x:0,y:0})=>{const i=6e4/e.fireRate,l=new Date().getTime();(!e.lastShotTime||l-e.lastShotTime>i)&&(AUDIO_MANAGER.playClip("laserShot"),e.lastShotTime=l,e.bullets.forEach(({dirX:r,dirY:o,offsetX:c,offsetY:u,type:d})=>{Ue(t,n,s.x+(c?a.x+c:a.x),s.y+(u?a.y+u:a.y),{x:r,y:o},d!=null?d:e.bulletType,e.damage)}))};class Fe extends W{constructor(){super(...arguments);f(this,"componentsRequired",new Set([z,x,j]))}update(s,n){Array.from(s).forEach(a=>{const i=this.ecs.getComponents(a),{gun:l,defaultOffset:r,enabled:o}=i.get(z),{value:c}=i.get(j),u=i.get(x);o&&u.y>0&&ge(this.ecs,l,u,c,r)})}}class He extends W{constructor(){super();f(this,"componentsRequired",new Set([x,L,M]))}update(s,n){const{height:a,width:i}=canvas,l=Array.from(s).map(r=>{var c,u;const o=this.ecs.getComponents(r);return{entity:r,tag:(c=o.get(H))==null?void 0:c.value,status:(u=o.get(j))==null?void 0:u.value,health:o.get(X),pos:o.get(x),speed:o.get(M),dir:o.get(L),col:o.get(ne),trans:o.get(w),anim:o.get(N),damage:o.get(Ae)}});l.forEach(r=>{var J,$,Q,he,de,ue;let{tag:o,health:c,status:u,anim:d,entity:E,pos:m,dir:T,speed:v,col:O,trans:U}=r,F=m.x+T.x*v.value*n,C=m.y+T.y*v.value*n;if(o===I.PLAYER&&((F<2||F>i-2-U.width)&&(F=m.x),(C<2||C>a-2-U.height)&&(C=m.y)),(O==null?void 0:O.enabled)&&U){const fe=l.filter(p=>{var k;return p.entity!==E&&((k=p.col)==null?void 0:k.enabled)&&p.trans&&We(m,U,p.pos,p.trans)});if(o===I.PLAYER){const p=fe.find(k=>k.status===B.ENEMY);p&&(c.curr-=p.damage?p.damage.value:1,AUDIO_MANAGER.playClip("hitHurt"),O.enabled=!1,setTimeout(()=>O.enabled=!0,1e3),Math.floor(c.curr)<=0&&(GAMESTATE.lives-=1,T.x=0,T.y=0,this.ecs.removeComponent(E,le),(J=d==null?void 0:d.animations)!=null&&J.death&&d.setState("death"),GAMESTATE.lives>0?setTimeout(()=>{ce(this.ecs)},2e3):(GAMESTATE.paused=!0,GAMESTATE.scene="gameOver")))}if(o===I.ENEMY&&C>a&&this.ecs.removeEntity(E),o===I.PROJECTILE){const p=fe.find(k=>k.tag===(u===B.FRIENDLY?I.ENEMY:I.PLAYER));(ke(F,C,i,a,10)||p)&&(p&&(($=p==null?void 0:p.health)!=null&&$.curr?(p.health.curr-=1,(he=(Q=p.anim)==null?void 0:Q.animations)!=null&&he.damage&&p.anim.setState("damage"),AUDIO_MANAGER.playClip("hitHurtEnemy")):((ue=(de=p.anim)==null?void 0:de.animations)!=null&&ue.death?(p.col.enabled=!1,p.anim.setState("death")):this.ecs.removeEntity(p.entity),AUDIO_MANAGER.playClip("explosion"),GAMESTATE.score+=p.health.max*10)),this.ecs.removeEntity(E))}}m.x=F,m.y=C})}}const We=(t,e,s,n)=>{const{width:a,height:i}=e,{width:l,height:r}=n,{x:o,y:c}=ee(t,e),{x:u,y:d}=ee(s,n);return!(o<u-a||o>u+l||c<d-i||c>d+r)},ke=(t,e,s,n,a=0)=>{const i=-a,l=-a,r=s+a,o=n+a;return t<i||t>r||e<l||e>o},qe=t=>{switch(t){case"large1":return[new M(30),new X(5,5),new w(28,28),new y(A.SPRITE,"blue",{x:28,y:56}),new N({default:g([{x:28,y:56}]),damage:g([{x:84,y:56}],"single",12),death:Y.explosion_large}),new V(b.FOLLOW),new z({fireMode:_.AUTO,fireRate:60,damage:1,bulletType:"ball_purple_small",bullets:[{dirX:0,dirY:-1,offsetX:0,offsetY:-14},K(q({},D(G(0,-1,45))),{offsetX:7,offsetY:-7}),{dirX:1,dirY:0,offsetX:14,offsetY:0},K(q({},D(G(0,1,-45))),{offsetX:7,offsetY:7}),{dirX:0,dirY:1,offsetX:0,offsetY:14},K(q({},D(G(0,1,45))),{offsetX:-7,offsetY:7}),{dirX:-1,dirY:0,offsetX:-14,offsetY:0},K(q({},D(G(0,-1,-45))),{offsetX:-7,offsetY:-7})]},{x:14,y:14})];case"small1":return[new M(150),new X(1,1),new w(14,14),new y(A.SPRITE,"blue",{x:0,y:56}),new N({default:g([{x:0,y:56}]),damage:g([{x:56,y:56}],"single",12),death:Y.explosion_small})];case"small2":return[new M(40),new X(1,1),new w(14,14),new V(b.HORIZONTAL_BAF),new y(A.SPRITE,"blue",{x:14,y:56}),new z({fireMode:_.AUTO,fireRate:60,damage:2,bulletType:"ball_purple",bullets:[{dirX:0,dirY:1}]},{x:7,y:18}),new N({default:g([{x:14,y:56}]),damage:g([{x:70,y:56}],"single",12),death:Y.explosion_small})];case"small3":return[new M(75),new X(1,1),new w(14,14),new y(A.SPRITE,"blue",{x:0,y:70}),new V(b.SINE_HORIZONTAL),new N({default:g([{x:0,y:70}]),damage:g([{x:56,y:70}],"single",12),death:Y.explosion_small}),new z({fireMode:_.AUTO,fireRate:60,damage:2,bulletType:"ball_purple_small",bullets:[D(G(0,1,45)),D(G(0,1,-45))]},{x:7,y:18})];case"small4":return[new M(20),new X(1,1),new w(14,14),new y(A.SPRITE,"blue",{x:14,y:70}),new V(b.SINE_VERTICAL),new N({default:g([{x:14,y:70}]),damage:g([{x:70,y:70}],"single",12),death:Y.explosion_small}),new z({fireMode:_.AUTO,fireRate:60,damage:1,bulletType:"laser_h",bullets:[{dirX:1,dirY:0,offsetX:7,offsetY:0},{dirX:-1,dirY:0,offsetX:-7,offsetY:0}]},{x:7,y:8})]}},Ke=(t,e,s,n)=>{const a=t.addEntity();return[new x(e,s),new H(I.ENEMY),new j(B.ENEMY),new ne(se.RECTANGLE),new L(0,1),...qe(n)].forEach(l=>{t.addComponent(a,Object.create(l))}),a};class Ve extends W{constructor(s,n=1.5){super();f(this,"baseMaxEnemyCount");f(this,"spawnCooldown");f(this,"lastSpawn",0);f(this,"componentsRequired",new Set([x,j,H]));this.baseMaxEnemyCount=s,this.spawnCooldown=n*1e3}update(s,n){const a=new Date().getTime(),i=Array.from(s).filter(r=>{const o=this.ecs.getComponents(r),{value:c}=o.get(H);return c===I.ENEMY}).length,l=Math.floor(GAMESTATE.score/75);if(i<this.baseMaxEnemyCount+l&&a-this.lastSpawn>this.spawnCooldown-l*.05){const r=["large1","small1","small2","small3","small4"],o=r[Math.floor(Math.random()*r.length)];let c=ie(0,canvas.width-28),u=-28;Ke(this.ecs,c,u,o),this.lastSpawn=a}}}class ze extends W{constructor(){super();f(this,"componentsRequired",new Set([L,V]))}update(s,n){s.forEach(a=>{var d;const i=this.ecs.getComponents(a),l=i.get(V),r=i.get(L),o=i.get(M),c=i.get(x),u=Math.sin(new Date().getTime()/500);if(l.type===b.SINE_HORIZONTAL)r.x=u;else if(l.type===b.SINE_VERTICAL&&c.y>30)r.y=u,o&&r.y>0?o.value=100:o&&(o.value=70);else if(l.type===b.HORIZONTAL_BAF&&c.y>5)r.y=0,c.x<0?r.x=1:c.x>canvas.width-14?r.x=-1:r.x===0&&(r.x=Math.random()>.5?-1:1);else if(l.type===b.FOLLOW){const E=(d=this.ecs.getComponents(GAMESTATE.playerEntity))==null?void 0:d.get(x);if(E){const m=E.x-c.x,T=E.y-c.y,v=pe({x:m,y:T});r.x=v.x,r.y=v.y}else r.x=0,r.y=c.x>0?-1:0}else r.y=1})}}const oe={UP:["w","arrowup"],DOWN:["s","arrowdown"],LEFT:["a","arrowleft"],RIGHT:["d","arrowright"],ACTION:[" "],MENU:["escape","p"],RESTART:["r"],SWITCH_WEAPON:["q","alt"],WEAPON_NUM:["1","2","3"]},R=t=>oe[t].some(e=>KEYMAP[e]),P=t=>oe[t].some(e=>KEYMAP[e])&&oe[t].every(e=>!KEYMAP_PREV[e]);class Be extends W{constructor(){super(...arguments);f(this,"componentsRequired",new Set([le,x,w,L,te]))}updateListeners(s){s.forEach(n=>{const a=this.ecs.getComponents(n);let i=a.get(L),l=a.get(x),r=a.get(w),o=a.get(N),c=a.get(te);(P("UP")||!R("DOWN")&&R("UP"))&&(i.y=-1),(P("DOWN")||!R("UP")&&R("DOWN"))&&(i.y=1),!R("UP")&&!R("DOWN")&&(i.y=0),(P("LEFT")||!R("RIGHT")&&R("LEFT"))&&(i.x=-1),(P("RIGHT")||!R("LEFT")&&R("RIGHT"))&&(i.x=1),!R("LEFT")&&!R("RIGHT")&&(i.x=0);const u=pe({x:i.x,y:i.y});if(i.x=u.x,i.y=u.y,o&&(i.x<0&&o.state!=="turning_left"?(o.state==="turning_right"&&o.setState("default"),o.setState("turning_left")):i.x>0&&o.state!=="turning_right"?(o.state==="turning_left"&&o.setState("default"),o.setState("turning_right")):i.x===0&&o.state!=="default"&&o.setState("default")),P("SWITCH_WEAPON")&&c&&(c.active=(c.active+1)%c.gunList.length),P("WEAPON_NUM")){const E=["1","2","3"].findIndex(m=>KEYMAP[m]);E!==void 0&&(c.active=E)}const d=c.getActive();if(d.fireMode===_.SEMIAUTO&&P("ACTION")||d.fireMode===_.AUTO&&R("ACTION")){const E={x:r.width/2,y:-5};ge(this.ecs,d,l,B.FRIENDLY,E)}})}update(s,n){P("MENU")&&GAMESTATE.scene==="game"&&(GAMESTATE.paused=!GAMESTATE.paused),P("RESTART")&&GAMESTATE.paused&&ye(this.ecs),!GAMESTATE.paused&&GAMESTATE.scene==="game"&&this.updateListeners(s)}}class je extends W{constructor(s,n,a){super();f(this,"componentsRequired",new Set([x,y]));f(this,"ctx");f(this,"spritesheet");f(this,"background");f(this,"title");f(this,"fonts");f(this,"stars",[]);f(this,"lastStarSpawn",0);f(this,"starSpeeds",[80,100,130,220]);f(this,"starColors",["#a4e4fc","#b8f8d8","#fcfcfc"]);f(this,"titleScreenPos",-200);f(this,"startGameTextShow",!1);this.ctx=s,this.spritesheet=n.spritesheetImg,this.title=n.titleImg,this.fonts=a,setInterval(()=>this.startGameTextShow=!this.startGameTextShow,750)}drawStars(s){const n=this.ctx,a=new Date().getTime();if((!GAMESTATE.paused||GAMESTATE.scene==="titleScreen")&&a-this.lastStarSpawn>50){const i=a,l=ie(1,canvas.width),r=ie(0,this.starSpeeds.length),o=this.starSpeeds[r],c=1;this.lastStarSpawn=a,this.stars.push({id:i,speed:o,size:c,position:{x:l,y:-5}})}this.stars.forEach(i=>{const{id:l,position:r,size:o,speed:c}=i;if(r.y>canvas.height){this.stars=this.stars.filter(d=>d.id!==l);return}n.save();const u=this.starColors[r.x%this.starColors.length];n.strokeStyle=u,n.fillStyle=u,n.beginPath(),n.fillRect(Math.round(r.x),Math.round(r.y),o,o),n.restore(),(!GAMESTATE.paused||GAMESTATE.scene==="titleScreen")&&(r.y+=c*s)})}drawEntities(s){const n=this.ctx;s.forEach(a=>{const i=this.ecs.getComponents(a),l=i.get(x),r=i.get(y),o=i.get(w),c=i.get(X),u=i.get(H),d=i.get(L),{x:E,y:m}=ee(l,o);if(r.spriteType===A.SPRITE){const{x:T,y:v}=r.currSprite;n.drawImage(this.spritesheet,T,v,o.width,o.height,E,m,o.width,o.height)}else if(r.spriteType===A.DIRECTIONAL_SPRITE&&d){const T=Ge(d),{x:v,y:O}=r.sprites[T]||r.sprites.default;n.drawImage(this.spritesheet,v,O,o.width,o.height,E,m,o.width,o.height)}else n.save(),n.strokeStyle=r.style,n.fillStyle=r.style,n.beginPath(),n.fillRect(Math.round(E),Math.round(m),o.width,o.height),n.restore();if(!GAMESTATE.paused&&(u==null?void 0:u.value)===I.PLAYER)for(let T=0;T<c.curr*3;T+=3)n.save(),n.fillStyle="#a81000",n.fillRect(l.x+7+T,l.y+o.height+1,2,2),n.restore()})}drawText(s,n,a,i){const l=this.ctx,{font:r=this.fonts.default,verticalAlign:o=h.END,horizontalAlign:c=h.START,scale:u=1,shadow:d}=i;let E=s.length*r.charWidth,m=r.charHeight;d&&(E+=Math.abs(d.offsetX),m+=Math.abs(d.offsetY));const T=Array.from(r.caseSensitive?s:s.toLowerCase()),{x:v,y:O}=ee({x:n,y:a},{width:E,height:m,horizontalAlign:c,verticalAlign:o});return l.save(),T.forEach((U,F)=>{let C=r.characterIndexes[U];if(U===" "||C===void 0)return;d&&(l.shadowColor=d.color,l.shadowOffsetX=d.offsetX,l.shadowOffsetY=d.offsetY);const J=Math.floor(r.img.naturalWidth/r.charWidth),$=C%J*r.charWidth,Q=Math.floor(C*r.charWidth/r.img.naturalWidth)*r.charHeight;l.drawImage(r.img,$,Q,r.charWidth,r.charHeight,v+r.charWidth*F,O,r.charWidth*u,r.charHeight*u)}),l.restore(),{w:E,h:m}}drawHUD(s){var c;const n={x:canvas.width/2,y:canvas.height/2-40};let a;GAMESTATE.paused&&(a=this.drawText(GAMESTATE.scene==="game"?"PAUSED":"GAME OVER",n.x,n.y,{horizontalAlign:h.CENTER,verticalAlign:h.CENTER,shadow:{color:"#a80020",offsetX:1,offsetY:1}}));const i=GAMESTATE.paused?{x:Math.floor(canvas.width/2-a.w/2),y:n.y+16}:{x:2,y:2},l=this.drawText(GAMESTATE.score.toString()+`${GAMESTATE.paused?" PTS":""}`,i.x,i.y,{horizontalAlign:h.START,verticalAlign:h.START,color:"red",shadow:{color:"#0058f8",offsetX:1,offsetY:0}}),r=GAMESTATE.paused?GAMESTATE.lives+" ships":Array(GAMESTATE.lives>0?GAMESTATE.lives:0).fill("\u2665").join("");GAMESTATE.scene==="game"&&this.drawText(r,i.x,i.y+l.h+2,{horizontalAlign:h.START,verticalAlign:h.START,color:"red",shadow:{color:"#a80020",offsetX:1,offsetY:0}}),GAMESTATE.paused&&this.drawText("PRESS R TO RESTART",canvas.width/2,i.y+60,{horizontalAlign:h.CENTER,verticalAlign:h.CENTER,shadow:{color:"#00b800",offsetX:1,offsetY:1}});const o=(c=this.ecs.getComponents(GAMESTATE.playerEntity))==null?void 0:c.get(te);!GAMESTATE.paused&&GAMESTATE.scene==="game"&&o&&this.drawText("W"+(o.active+1),i.x,i.y+l.h*3,{horizontalAlign:h.START,verticalAlign:h.START,color:"red",shadow:{color:"#a80020",offsetX:1,offsetY:0}})}drawTitleScreen(s){const n=this.ctx;n.save(),n.drawImage(this.title,0,this.titleScreenPos),n.restore(),this.titleScreenPos<0&&(this.titleScreenPos+=250*s),this.startGameTextShow&&this.drawText("Click to start!",canvas.width/2,canvas.height-canvas.height/3,{horizontalAlign:h.CENTER,verticalAlign:h.CENTER,color:"red",shadow:{color:"#a80020",offsetX:1,offsetY:1}})}update(s,n){if(this.drawStars(n),GAMESTATE.scene==="titleScreen"){this.drawTitleScreen(n);return}this.drawEntities(s),this.drawHUD(n)}}globalThis.canvas=document.querySelector("#gameCanvas");canvas.tabIndex=1;we();window.onresize=()=>we();const Z=canvas.getContext("2d");Z.lineWidth=2;Z.imageSmoothingEnabled=!1;Z.font="8px 'Press Start 2P'";const Te=new(window.AudioContext||window.webkitAudioContext);globalThis.KEYMAP={};globalThis.KEYMAP_PREV={};const Se=t=>{KEYMAP[t.key.toLowerCase()]=t.type==="keydown"},xe=()=>{KEYMAP={},KEYMAP_PREV={}};window.addEventListener("keydown",Se);window.addEventListener("keyup",Se);window.onblur=()=>xe();window.onfocus=()=>xe();(async()=>{const t=[{name:"laserShot",url:"assets/laserShoot.wav"},{name:"explosion",url:"assets/explosion.wav"},{name:"death",url:"assets/death.wav"},{name:"hitHurt",url:"assets/hitHurt.wav"},{name:"hitHurtEnemy",url:"assets/hitHurt2.wav"},{name:"intro",url:"assets/intro.wav"},{name:"main",url:"assets/main.wav"}],[e,s,n,a]=await Promise.all([Ye(Te,t),ae("assets/spritesheet.png"),ae("assets/title.png"),ae("assets/default-font-no-shadow.png")]);globalThis.AUDIO_MANAGER=_e(Te,e,.2);const i={default:{img:a,characterIndexes:be("abcdefghijklmnopqrstuvwxyz0123456789.!-:\u2665"),charWidth:9,charHeight:11,caseSensitive:!1}},l=new Oe;globalThis.SYSTEMS={inputSystem:new Be,autofireSystem:new Fe,movementPatternSystem:new ze,collisionSystem:new He,enemySpawnerSystem:new Ve(3),animationSystem:new De,renderingSystem:new je(Z,{spritesheetImg:s,titleImg:n},i)},Object.values(SYSTEMS).forEach(d=>l.addSystem(d)),globalThis.GAMESTATE={playerEntity:-1,paused:!0,scene:"titleScreen",lives:3,score:0},ce(l),canvas.addEventListener("click",async()=>{await AUDIO_MANAGER.audioCtx.resume(),AUDIO_MANAGER.playClip("intro",{volume:.7,onEnded:()=>AUDIO_MANAGER.playClip("main",{loop:!0,volume:.7})}),setTimeout(()=>ye(l),100)},{once:!0});let r=0;const c=1e3/72;requestAnimationFrame(u);function u(d){requestAnimationFrame(u);const E=d-r;E<=c||(["autofireSystem","collisionSystem","enemySpawnerSystem","animationSystem"].forEach(m=>{const T=SYSTEMS[m];T&&T.enabled===GAMESTATE.paused&&(T.enabled=!GAMESTATE.paused)}),r=d,Z.clearRect(0,0,canvas.width,canvas.height),l.update(E/1e3),KEYMAP_PREV=Object.assign(KEYMAP_PREV,KEYMAP))}})();
